<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Jokul by DOKU Signature Calculator</title>
    <link rel="stylesheet"
        href="https://cdn-doku.oss-ap-southeast-5.aliyuncs.com/doku-ui-framework/doku/stylesheet/css/main.css">
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h2>Jokul Signature Calculator</h2>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <form id="preparation" onsubmit="putSignatureComponent(); return false">
                    <div class="card">
                        <div class="card-header">
                            <h4>1. Preparation</h4>
                        </div>

                        <div class="card-body">
                            <div class="card">
                                <div class="card-header">
                                    <h4>a. Prepare Digest Value (Leave this empty for GET and DELETE Method)</h4>
                                </div>

                                <div class="card-body">
                                    <div class="form-group">
                                        <label>Put your JSON request body</label>
                                        <textarea onkeyup="hashRequestBody();" id="request_body" class="form-control"
                                            rows="10"></textarea>
                                    </div>

                                    <div class="form-group">
                                        <label>Calculate SHA256 base64 hash from your JSON request body</label>
                                        <input type="text" id="digest_value" class="form-control" disabled></input>
                                    </div>
                                </div>
                            </div>

                            <div class="card mt-3">
                                <div class="card-header">
                                    <h4>b. Prepare Signature Component</h4>
                                </div>

                                <div class="card-body">
                                    <div class="form-group">
                                        <label>Client-Id</label>
                                        <input type="text" id="client_id" class="form-control"
                                            value="MCH-0101-8574378255608"></input>
                                        <small>Get your Client-Id from <a href="https://jokul.doku.com/bo/login"
                                                target="_blank">Jokul Back Office</a> / <a
                                                href="https://sandbox.doku.com/bo/login" target="_blank">Sandbox Jokul
                                                Back Office</a></small>
                                    </div>

                                    <div class="form-group">
                                        <label>Secret-Key</label>
                                        <input type="text" id="secret_key" class="form-control"
                                            value="SK-qm9dGcnAjCHj88ddBfuY"></input>
                                        <small>Secret-Key used to generate the signature. Get your Secret-Key from <a
                                                href="https://jokul.doku.com/bo/login" target="_blank">Jokul Back
                                                Office</a> / <a href="https://sandbox.doku.com/bo/login"
                                                target="_blank">Sandbox Jokul Back Office</a></small>
                                    </div>

                                    <div class="form-group">
                                        <label>Request-Id</label>
                                        <input type="text" id="request_id" class="form-control"
                                            value="a4dec55c-8533-462b-bcb2-4a8a233578a4"></input>
                                        <small>Request-Id is unique value generated by you to ensure the request is not
                                            duplicated (max 128 characters)</small>
                                    </div>

                                    <div class="form-group">
                                        <label>Request-Timestamp</label>
                                        <input type="text" id="request_timestamp" class="form-control"
                                            value="2020-10-21T03:38:28Z"></input>
                                        <small>Request-Timestamp uses ISO 8601 timestamp format. Example:
                                            <code>2020-10-21T03:38:28Z</code></small>
                                    </div>

                                    <div class="form-group">
                                        <label>Request-Target</label>
                                        <input type="text" id="request_target" class="form-control"
                                            value="/doku-virtual-account/v2/payment-code"></input>
                                        <small>Request-Target is DOKU resource-path minus host domain. Example:
                                            <code>/doku-virtual-account/v2/payment-code</code></small>
                                    </div>

                                    <div class="form-group">
                                        <label>After all the components above filled, Arrange the signature components
                                            to one component and its value per line by adding <code>\n</code>. Do NOT
                                            use <code>\n</code> at the end of the string</label><br>
                                        <input type="submit" class="btn btn-primary"
                                            value="Prepare Signature Component"></input>
                                    </div>

                                    <div class="form-group">
                                        <label>This is the raw format of the signature component</label>
                                        <textarea id="raw_signature_component" class="form-control" rows="3"
                                            disabled></textarea>
                                    </div>

                                    <div class="form-group">
                                        <label>This how you see the signature component</label>
                                        <textarea id="formatted_signature_component" class="form-control" rows="5"
                                            disabled></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <form id="generation" onsubmit="generateSignature(); return false">
                    <div class="card mt-3">
                        <div class="card-header">
                            <h4>2. Generate Signature</h4>
                        </div>

                        <div class="card-body">
                            <div class="form-group">
                                <label>Click the following button to generate the signature</label><br>
                                <input type="submit" class="btn btn-primary" value="Generate Signature"></input><br>
                                <small>By clicking the button above, you will calculate HMAC-SHA256 Base64 the signature
                                    component with the Secret Key from Jokul Back Office then prepend
                                    <code>HMACSHA256=</code> to the signature</small>
                            </div>

                            <div class="form-group">
                                <label>1. Calculate HMAC-SHA256 base64 hash from all the components above using the
                                    Secret Key from Jokul Back Office</label>
                                <input type="text" id="encoded_signature" class="form-control" disabled></input>
                            </div>

                            <div class="form-group">
                                <label>2. Prepend <code>HMACSHA256=</code></label>
                                <input type="text" id="prepended_signature" class="form-control" disabled></input>
                            </div>

                            <p><strong>Congratulations!</strong> Now you have generated the Signature. It's time to put
                                the Signature to your request header.</p>
                        </div>
                    </div>
                </form>

                <div class="card mt-3">
                    <div class="card-header">
                        <h4>3. Put the Signature to the Request Header</h4>
                    </div>

                    <div class="card-body">
                        <p>Here is preview of your header request:</p>

                        <code>
                            Content-Type: application/json<br>
                            Client-Id: <span id="final_client_id"></span><br>
                            Request-Id: <span id="final_request_id"></span><br>
                            Request-Timestamp: <span id="final_request_timestamp"></span><br>
                            Signature: <span id="final_signature"></span><br>
                        </code>

                    </div>
                </div>
            </div>
        </div>

        <footer>
            <div class="row my-3">
                <div class="col-12 text-center">
                    <span>Powered by <img
                            src="https://cdn-doku.oss-ap-southeast-5.aliyuncs.com/doku-ui-framework/doku/img/doku1.png"
                            alt="DOKU" width="25" height="25"></span>
                </div>
            </div>
        </footer>
    </div>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js">
    </script>
    <script>
        var hashRequestBody = function () {
            var body = document.querySelector('#request_body').value;
            document.querySelector('#digest_value').value = CryptoJS.enc.Base64.stringify(CryptoJS.SHA256(body));
        }

        var putSignatureComponent = function () {

            var backSlashN = "%5Cn";
            var clientId = document.querySelector('#client_id').value;
            var requestId = document.querySelector('#request_id').value;
            var requestTimestamp = document.querySelector('#request_timestamp').value;
            var requestTarget = document.querySelector('#request_target').value;
            var digest = document.querySelector('#digest_value').value;
            var request_body = document.querySelector('#request_body').value;

            if (request_body.length == 0) {
                document.querySelector('#raw_signature_component').value =
                "Client-Id:" + clientId + decodeURIComponent(backSlashN) +
                "Request-Id:" + requestId + decodeURIComponent(backSlashN) +
                "Request-Timestamp:" + requestTimestamp + decodeURIComponent(backSlashN) +
                "Request-Target:" + requestTarget

                document.querySelector('#formatted_signature_component').value =
                "Client-Id:" + clientId + "\n" +
                "Request-Id:" + requestId + "\n" +
                "Request-Timestamp:" + requestTimestamp + "\n" +
                "Request-Target:" + requestTarget
            } else {
                document.querySelector('#raw_signature_component').value =
                "Client-Id:" + clientId + decodeURIComponent(backSlashN) +
                "Request-Id:" + requestId + decodeURIComponent(backSlashN) +
                "Request-Timestamp:" + requestTimestamp + decodeURIComponent(backSlashN) +
                "Request-Target:" + requestTarget + decodeURIComponent(backSlashN) +
                "Digest:" + digest

                document.querySelector('#formatted_signature_component').value =
                "Client-Id:" + clientId + "\n" +
                "Request-Id:" + requestId + "\n" +
                "Request-Timestamp:" + requestTimestamp + "\n" +
                "Request-Target:" + requestTarget + "\n" +
                "Digest:" + digest
            }
                
        }

        var generateSignature = function () {
            var signatureComponent = document.querySelector('#formatted_signature_component').value;
            var secretKey = document.querySelector('#secret_key').value;
            var clientId = document.querySelector('#client_id').value;
            var requestId = document.querySelector('#request_id').value;
            var requestTimestamp = document.querySelector('#request_timestamp').value;
            var prependHashingMethod = "HMACSHA256=";

            var encodedSignature = document.querySelector('#encoded_signature').value = CryptoJS.enc.Base64
                .stringify(CryptoJS.HmacSHA256(signatureComponent, secretKey));

            document.querySelector('#prepended_signature').value = prependHashingMethod + encodedSignature;
            document.querySelector('#final_signature').innerHTML = prependHashingMethod + encodedSignature;
            document.querySelector('#final_client_id').innerHTML = clientId;
            document.querySelector('#final_request_id').innerHTML = requestId;
            document.querySelector('#final_request_timestamp').innerHTML = requestTimestamp;
        }
    </script>
</body>

</html>
